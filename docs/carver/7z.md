# 7Z Carver

## Overview

The 7Z carver extracts 7-Zip archive files by parsing the header structure and using embedded metadata to calculate the total file size.

## Signature Detection

**Header Pattern**: `7z\xBC\xAF\x27\x1C` (6 bytes)
- Bytes: 0x37 0x7A 0xBC 0xAF 0x27 0x1C
- These magic bytes uniquely identify 7-Zip archives

## Carving Algorithm

7-Zip uses a metadata-driven structure:

### 1. Header Parsing (32 bytes)

```
Offset  Size  Description
0       6     Signature ("7z\xBC\xAF\x27\x1C")
6       2     Archive version (major.minor)
8       4     Start header CRC
12      8     Next header offset (little-endian u64)
20      8     Next header size (little-endian u64)
28      4     Next header CRC
```

### 2. Size Calculation

```rust
let next_header_offset = u64::from_le_bytes([
    header[12], header[13], header[14], header[15],
    header[16], header[17], header[18], header[19]
]);

let next_header_size = u64::from_le_bytes([
    header[20], header[21], header[22], header[23],
    header[24], header[25], header[26], header[27]
]);

let total_size = 32 + next_header_offset + next_header_size;
```

The "next header" contains the archive's central directory (metadata about all files, compression info, etc.).

### 3. Carving

```rust
let target_size = total_size.min(max_size);
write_range(ctx, hit.global_offset, hit.global_offset + target_size, ...)?;
```

## Validation

- **Validated**: `true` if:
  - Signature matches exactly
  - Calculated total_size >= 32 bytes
- **Truncated**: `true` if:
  - max_size enforced before complete size
  - EOF reached before complete size
- **Invalid**: Removed if:
  - Signature mismatch
  - total_size < 32 bytes

## Size Constraints

- **Default min_size**: 32 bytes (size of 7z header)
- **Default max_size**: 2 GB
- Minimum viable 7z: 32 bytes (header only, empty archive)
- Files below min_size are discarded

## Hash Computation

- **MD5**: Computed via `write_range` during copy
- **SHA-256**: Computed via `write_range` during copy
- Covers complete archive from signature to calculated end

## Testing

**Test file**: `tests/carver_7z.rs`

### Test Strategy

Golden image framework with various 7z types:

1. **Test archives**:
   - Standard 7z archives
   - LZMA compression
   - LZMA2 compression
   - Solid archives (all files compressed together)
   - Encrypted archives
   - Multi-volume archives
   - Archives with headers compression

2. **Verification**:
   - All 7z archives found at expected offsets
   - Sizes match manifest exactly
   - All marked as validated
   - Archives can be extracted with `7z x`

## Edge Cases Handled

1. **Empty archives**: Handles archives with no files (header only)
2. **Large offsets**: Supports 64-bit offsets and sizes
3. **Encrypted archives**: Carves complete archive (no decryption)
4. **Solid archives**: Preserves entire compressed block
5. **Header compression**: Metadata header can itself be compressed

## Performance Characteristics

- **Metadata-driven**: Size known from header (very efficient)
- **Memory usage**: Minimal (reads header only)
- **I/O pattern**: Small header read + sequential copy
- **No decompression**: Archive copied as-is

## Forensic Considerations

- **High compression**: LZMA provides excellent compression ratios
- **Encryption support**: AES-256 encryption available (not broken)
- **Timestamps**: Archive contains file modification times
- **Solid archives**: All files compressed together (better compression, but cannot extract individual files independently)

## 7Z Structure Overview

```
[Start Header: 32 bytes]
  Signature: "7z\xBC\xAF\x27\x1C"
  Version: 0.4
  Start Header CRC: 0x12345678
  Next Header Offset: 1048576 (from end of start header)
  Next Header Size: 4096
  Next Header CRC: 0x9ABCDEF0

[Compressed Data: variable length]
  [Compressed file data for all files in archive]
  (Size = Next Header Offset)

[Next Header (Central Directory): 4096 bytes]
  [Metadata describing all files, folders, compression methods, etc.]
  This can be compressed or uncompressed

[Optional: Padding/alignment bytes]
```

## Next Header Structure

The "Next Header" contains:
- **Files Info**: Names, attributes, timestamps
- **Folders Info**: Compression methods, dictionaries
- **Streams Info**: CRCs, sizes (compressed/uncompressed)
- **Coders Info**: Which compression algorithms used

## 7Z Compression Methods

7-Zip supports many compression methods:
- **LZMA**: Default, excellent compression
- **LZMA2**: Improved LZMA with better multithreading
- **PPMd**: Good for text files
- **BZip2**: Alternative compression
- **Deflate**: ZIP-compatible compression
- **Copy**: No compression (stored)

## Known Limitations

1. **No CRC validation**: Doesn't verify CRCs (forensic mode)
2. **No decompression**: Doesn't validate compressed data
3. **Assumes contiguous**: Doesn't handle split archives across volumes
4. **Header offset trusted**: Relies on embedded offset/size metadata

## Related Carvers

- **ZIP**: Alternative archive format (more common)
- **RAR**: Alternative archive format (proprietary)
- **TAR**: Uncompressed archive format
- **XZ**: Uses LZMA compression (single-file)
